version: '3.8'

services:
  # Open WebUI服务
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    ports:
      - "8888:8080"
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - WEBUI_SECRET_KEY=your-secret-key-here
    volumes:
      - open-webui:/app/backend/data
      - ./static:/app/backend/static/custom
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    depends_on:
      - voice-assistant

  # 语音助手API服务
  voice-assistant:
    build: .
    container_name: voice-assistant
    ports:
      - "8889:8889"
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    volumes:
      - whisper-cache:/root/.cache/whisper
      - ./static:/app/static
    restart: unless-stopped
    # GPU支持 (需要nvidia-docker)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

volumes:
  open-webui:
  whisper-cache: